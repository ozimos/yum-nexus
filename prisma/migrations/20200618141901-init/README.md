# Migration `20200618141901-init`

This migration has been generated by Tovieye Moses Ozi at 6/18/2020, 2:19:01 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "Role" AS ENUM ('ADMIN', 'CATERER');

CREATE TYPE "Status" AS ENUM ('DISPATCHED', 'CANCELLED', 'FULFILLED', 'PENDING', 'PROCESSING');

CREATE TABLE "yum_diner"."Address" (
"areaCode" integer  NOT NULL ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" text  NOT NULL ,"lga" text  NOT NULL ,"state" text  NOT NULL ,"street1" text  NOT NULL ,"street2" text   ,"updatedAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"userId" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "yum_diner"."DefaultAddress" (
"addressId" text  NOT NULL ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"userId" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "yum_diner"."Meal" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"deletedAt" timestamp(3)   ,"description" text  NOT NULL ,"id" text  NOT NULL ,"imageUrl" text  NOT NULL ,"price" Decimal(65,30)  NOT NULL ,"tags" text []  ,"title" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"userId" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "yum_diner"."MealOrder" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" text  NOT NULL ,"mealId" text  NOT NULL ,"orderId" text  NOT NULL ,"quantity" integer  NOT NULL DEFAULT 1,"updatedAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY ("id"))

CREATE TABLE "yum_diner"."Menu" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" text  NOT NULL ,"menuDate" timestamp(3)  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"userId" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "yum_diner"."Order" (
"addressId" text   ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" text  NOT NULL ,"status" "Status" NOT NULL DEFAULT E'PENDING',"updatedAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"userId" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "yum_diner"."User" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"email" text  NOT NULL ,"facebookId" text   ,"firstName" text   ,"googleId" text   ,"id" text  NOT NULL ,"lastName" text   ,"password" text   ,"picture" text   ,"roles" "Role"[]  ,"tokenVersion" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY ("id"))

CREATE TABLE "yum_diner"."_MealMenu" (
"A" text  NOT NULL ,"B" text  NOT NULL )

CREATE UNIQUE INDEX "addressMine" ON "yum_diner"."Address"("id","userId")

CREATE UNIQUE INDEX "DefaultAddress.userId" ON "yum_diner"."DefaultAddress"("userId")

CREATE UNIQUE INDEX "mealMine" ON "yum_diner"."Meal"("id","userId")

CREATE UNIQUE INDEX "meal_order" ON "yum_diner"."MealOrder"("mealId","orderId")

CREATE UNIQUE INDEX "menuMine" ON "yum_diner"."Menu"("menuDate","userId")

CREATE UNIQUE INDEX "orderMine" ON "yum_diner"."Order"("id","userId")

CREATE UNIQUE INDEX "User.email" ON "yum_diner"."User"("email")

CREATE UNIQUE INDEX "User.facebookId" ON "yum_diner"."User"("facebookId")

CREATE UNIQUE INDEX "User.googleId" ON "yum_diner"."User"("googleId")

CREATE UNIQUE INDEX "_MealMenu_AB_unique" ON "yum_diner"."_MealMenu"("A","B")

CREATE  INDEX "_MealMenu_B_index" ON "yum_diner"."_MealMenu"("B")

ALTER TABLE "yum_diner"."Address" ADD FOREIGN KEY ("userId")REFERENCES "yum_diner"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "yum_diner"."DefaultAddress" ADD FOREIGN KEY ("addressId", "userId")REFERENCES "yum_diner"."Address"("id","userId") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "yum_diner"."DefaultAddress" ADD FOREIGN KEY ("userId")REFERENCES "yum_diner"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "yum_diner"."Meal" ADD FOREIGN KEY ("userId")REFERENCES "yum_diner"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "yum_diner"."MealOrder" ADD FOREIGN KEY ("mealId")REFERENCES "yum_diner"."Meal"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "yum_diner"."MealOrder" ADD FOREIGN KEY ("orderId")REFERENCES "yum_diner"."Order"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "yum_diner"."Menu" ADD FOREIGN KEY ("userId")REFERENCES "yum_diner"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "yum_diner"."Order" ADD FOREIGN KEY ("addressId")REFERENCES "yum_diner"."Address"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "yum_diner"."Order" ADD FOREIGN KEY ("userId")REFERENCES "yum_diner"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "yum_diner"."_MealMenu" ADD FOREIGN KEY ("A")REFERENCES "yum_diner"."Meal"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "yum_diner"."_MealMenu" ADD FOREIGN KEY ("B")REFERENCES "yum_diner"."Menu"("id") ON DELETE CASCADE  ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20200618141901-init
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,125 @@
+generator client {
+  provider = "prisma-client-js"
+}
+
+datasource db {
+  provider = "postgresql"
+  url      = env("DATABASE_URL")
+}
+
+model Address {
+  areaCode  Int
+  createdAt DateTime @default(now())
+  id        String   @default(cuid()) @id
+  lga       String
+  state     String
+  street1   String
+  street2   String?
+  updatedAt DateTime @default(now())
+  userId    String
+  user      User     @relation(fields: [userId], references: [id])
+
+  @@unique([id, userId], name: "addressMine")
+}
+
+model DefaultAddress {
+  id        String   @default(cuid()) @id
+  createdAt DateTime @default(now())
+  updatedAt DateTime @default(now())
+  addressId String
+  address   Address  @relation(fields: [addressId, userId], references: [id, userId])
+  userId    String   @unique
+  user      User     @relation(fields: [userId], references: [id])
+}
+
+model Meal {
+  createdAt   DateTime    @default(now())
+  deletedAt   DateTime?
+  description String
+  id          String      @default(cuid()) @id
+  imageUrl    String
+  price       Float
+  tags        String[]
+  title       String
+  updatedAt   DateTime    @default(now())
+  userId      String
+  user        User        @relation(fields: [userId], references: [id])
+  orders      MealOrder[]
+  menus       Menu[]      @relation("MealMenu", references: [id])
+
+  @@unique([id, userId], name: "mealMine")
+}
+
+model MealOrder {
+  createdAt DateTime @default(now())
+  id        String   @default(cuid()) @id
+  mealId    String
+  orderId   String
+  quantity  Int      @default(1)
+  updatedAt DateTime @default(now())
+  meal      Meal     @relation(fields: [mealId], references: [id])
+  order     Order    @relation(fields: [orderId], references: [id])
+
+  @@unique([mealId, orderId], name: "meal_order")
+}
+
+model Menu {
+  createdAt DateTime @default(now())
+  id        String   @default(cuid()) @id
+  menuDate  DateTime
+  updatedAt DateTime @default(now())
+  userId    String
+  user      User     @relation(fields: [userId], references: [id])
+  meals     Meal[]   @relation("MealMenu", references: [id])
+
+  @@unique([menuDate, userId], name: "menuMine")
+}
+
+model Order {
+  createdAt       DateTime    @default(now())
+  id              String      @default(cuid()) @id
+  status          Status      @default(PENDING)
+  updatedAt       DateTime    @default(now())
+  userId          String
+  addressId       String?
+  deliveryAddress Address?    @relation(fields: [addressId], references: [id])
+  user            User        @relation(fields: [userId], references: [id])
+  meals           MealOrder[]
+
+  @@unique([id, userId], name: "orderMine")
+}
+
+model User {
+  createdAt      DateTime        @default(now())
+  email          String          @unique
+  firstName      String?
+  id             String          @default(cuid()) @id
+  facebookId     String?         @unique
+  googleId       String?         @unique
+  lastName       String?
+  tokenVersion   String          @default(cuid())
+  // Json type is optimal but will use String for now
+  // see https://github.com/graphql-nexus/nexus/issues/947
+  picture        String?
+  password       String?
+  roles          Role[]
+  updatedAt      DateTime        @default(now())
+  defaultAddress DefaultAddress?
+  addresses      Address[]
+  meals          Meal[]
+  menus          Menu[]
+  orders         Order[]
+}
+
+enum Role {
+  ADMIN
+  CATERER
+}
+
+enum Status {
+  DISPATCHED
+  CANCELLED
+  FULFILLED
+  PENDING
+  PROCESSING
+}
```
